---
title: "Evaluation des Réparations de Vérins Piqueur Aventics"
author: "OG"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  html_document:
    theme: united
    number_sections: yes
    toc: yes
    toc_float: yes
    code_folding: hide
    df_print: paged
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = T,
                      include = F,
                      eval = T,
                      message = F,
                      warning = F
                    )
ggplot2::theme_set(ggplot2::theme_light())
library(tidyverse)
library(glue)
library(lubridate)
```

# objectif

> Analyse de la performance des DPA sur la base des données de
> réparation Mille. En particulier analyser les maintenances des vérins
> piqueur.

```{r dataload}
d <- readxl::read_xlsx("data/reparations_DPA.xlsx") |> # Données Issues de l'app Suivi reparations DPA
  mutate(mois = floor_date(dat, "m"))
min_dat <- min(d$dat)
max_dat <- max(d$dat)
```

# Données

> Données du `r min_dat` au `r max_dat`

```{r listePostes, include=TRUE}
d |> 
  group_by(composant, posteReparation) |> 
  count() |> 
  arrange(desc(n)) |> 
  divUtils::formatDT(cap = "Nombre d'interventions par poste dans la période")
```

# Nombre de maintenances piqueur

```{r plotMaintPiq, include=TRUE}
d |> 
  filter(posteReparation == "piqMaintenance2") |> 
  ggplot(aes(mois)) +
  geom_bar(alpha = .7, color = "black") +
  labs(title = "Nombre de maintenance 2 de vérins piqueur DPA par mois", y = "")
```

## Liste des Interventions Maintenance 2

```{r  inteventionsVérins, include=TRUE}
d |> 
  filter(posteReparation == "piqMaintenance2") |> 
  select(numeroDPA, numeroVerinPiqueurDemonté, dat,  numeroVerinPiqueurMonté, posteReparation) |>
  arrange(numeroDPA, dat) |> 
  divUtils::formatDT(dt = "dat")
 
```

## Nombre de Maintenance 2 par Vérin Piqueur

```{r nbMaintPiq, include=TRUE}
d |> 
  filter(posteReparation == "piqMaintenance2" & !is.na(numeroVerinPiqueurDemonté)) |> 
  group_by(numeroVerinPiqueurDemonté) |> 
  summarise(nombre_interventions = n()) |> 
  group_by(nombre_interventions) |> 
  summarise(nombre_piqueurs = n()) |> 
  divUtils::formatKable(cap = "Nombre de maintenance N2 par piqueur")
```

```{r nbVerinsRénovés}
nbVerRenov <- d |> 
  filter(posteReparation == "piqMaintenance2" & !is.na(numeroVerinPiqueurDemonté)) |> 
  summarise(n_distinct(numeroVerinPiqueurDemonté)) |> pull() 
```

> Nombre de Vérins Piqueur en maintenance 2 : **`r nbVerRenov`**

## Piqueurs avec Nombreuses Maintenances Niveau 2

```{r piqNombreusesInt, include=TRUE}
d |> 
  filter(posteReparation == "piqMaintenance2" & !is.na(numeroVerinPiqueurDemonté)) |> 
  group_by(numeroVerinPiqueurDemonté) |> 
  summarise(nombre_interventions = n()) |> 
  filter(nombre_interventions > 2 ) |> 
  arrange(desc(nombre_interventions)) |> 
  divUtils::formatKable()
```

## Durée de vie des Vérins rénovés

```{r duréeInterventions}
data_vie <- 
d |> 
   filter(posteReparation == "piqMaintenance2" & !is.na(numeroVerinPiqueurDemonté)) |> 
  select(
    numeroVerinPiqueurDemonté, dat
  ) |>
  group_by(numeroVerinPiqueurDemonté) |> 
  arrange(numeroVerinPiqueurDemonté) |> 
  mutate(dat_lag = lag(dat)) |> 
  mutate(dur_vie = if_else(!is.na(dat_lag),
                           as.numeric(difftime(dat_lag, dat, units = "days")),
                           as.numeric(difftime(Sys.Date(), dat, units = "days"))
                           ),
         C = if_else(is.na(dat_lag), 0, 1),
         group = "1"
  ) |> 
  ungroup() |> 
  select(
    dur_vie,
    C,
    group
  )
```

```{r plotDurVie2, include=TRUE}
survStan::plotHistoAgeWeibull(
   data_vie,
   time_col = "dur_vie",
   censor_col = "C",
   group_col = "group",
   age_max = 1000,
   tt = "Histogramme des ages des vérins réparés"
  )
```

```{r estimDurVie, eval = T, include=TRUE}
post <- survStan::getMeanLifePosterior(
  data_vie,
  group_col = "group",
  time_col = "dur_vie",
  censor_col = "C",
  maxLife = 2000,
  age_target = 1000
)
survStan::plotPostLife(post, xScale = c(0, 2000), t = "Distribution des durées de vie moyennes des  vérins piqueurs réparés") +
  scale_x_continuous(breaks = seq(0, 2000, 100)) 
```

```{r plotSurvie, include=TRUE}
survStan::plotSurvivalKP(data_vie,
                         time_col = "dur_vie",
                         censor_col = "C",
                         group_col = "group"
                         
                         ) +
  labs(title = "Graphique de Survie des vérins réparés", x = "age en jours") +
  coord_cartesian(ylim = c(0,1))
```
