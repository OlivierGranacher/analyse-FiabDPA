---
title: "Analyse des factures mensuelles DPA de Mille"
author: "OG"
format: 
  html:
    embed-resources: true
    toc: true
date: last-modified
lang: fr
code-fold: true
number-sections: true
editor: visual
fig-width: 8
fig-asp: .62
fig-align: left
execute:
  eval: true
  cache: false
  warning: false
  echo: false
  include: false
theme: flatly
---

```{r}
#| label: setup
#| cache: true
library(dplyr)
library(glue)
library(lubridate)
library(ggplot2)
theme_set(customColors::theme_potline())
# palette name pour plots - MetBrewer Package
pal_name <- "Austria"
file_path <- "data/factures_dpa_Mille.xlsx"
```

```{r}
#| label: plot_pareto_cout_fn
# Définition de la fonction plot_pareto_cout
plot_pareto_cout <- function(categorie, group_var, title, is_global = FALSE) {
  if (is_global) {
    ddd |> 
      group_by({{group_var}}) |> 
      summarise(cout_total = sum(cout)/cout_total) |> 
      divUtils::plotPareto({{group_var}}, cout_total, {{group_var}}, flip = T)
  } else {
    ddd |> 
      filter(categorie == {{categorie}}) |> 
      group_by({{group_var}}) |> 
      summarise(cout_total = sum(cout)/cout_total) |> 
      divUtils::plotPareto({{group_var}}, cout_total, {{group_var}}, flip = T)
  } +
    theme(legend.position = "none") +
    scale_y_continuous(labels = scales::label_percent()) +
    labs(title = title,
         subtitle = date_range_title,
         x = "",
         y = sub)
}
```

## Objectif

> Visualiser la décomposition des coûts de réparation des DPA sur la \> base des factures mensuelles de Mille

```{r}
#| label: import_data
# Import des données des diagnostics et réparations
d_raw <- readxl::read_xlsx(
  path = file_path,
  sheet = "data_detail",
  range = "A:E"
) |> janitor::clean_names() |> 
  mutate(across(where(is.character), .fns = ~stringr::str_to_lower(.x)))
### période des données
dat_min <- min(d_raw$mois) |> format("%d-%m-%Y")
dat_max <- max(d_raw$mois) |> format("%d-%m-%Y")
# Import des catégories d'interventions
cat <- readxl::read_xlsx(
  path = file_path,
  sheet = "listes",
  range = "C:D"
) |> janitor::clean_names() |> 
  mutate(across(where(is.character), .fns = ~stringr::str_to_lower(.x)))
# Import des totaux couts par mois
cout_mois <- readxl::read_xlsx(
  path = file_path,
  sheet = "data_mois",
  range = "A:B"
) |> janitor::clean_names() |> 
# Concaténation des données
ddd <- d_raw |> 
  left_join(
    cat,
    join_by(poste)
  ) |> 
  left_join(
    cout_mois,
    join_by(mois)
            )
# n_mois nombre de mois analysés
n_mois <- nrow(cout_mois)
# Cout total de tous les mois
cout_total <- sum(cout_mois$cout_dpa_mois)
# date range
### période des données
mois_min <- min(d_raw$mois) |> format("%B %Y")
mois_max <- max(d_raw$mois) |> format("%B %Y")
date_range_title <- glue("{n_mois} mois de {mois_min} à {mois_max}")
# Subtitle 
sub <- "% de la facture totale"
 
```

## Vérification des données

### Poste sans cout dans le mois

```{r}
#| label: couts_poste_mois
#| include: true
ddd |> 
group_by(poste) |> 
count() |> 
  ungroup() |> 
filter(n < n_mois) |> 
  gt::gt(caption = "Postes non présents tous les mois") |> 
  gt::opt_stylize(color = "gray")
```

### Couverture des Coûts Mensuels

> Pourcentage des couts analysés chaque mois

```{r}
#| label: pc_couts
#| include: true

ddd |> 
group_by(mois) |> 
summarise(pc_cout_analyse = sum(cout)/max(cout_dpa_mois)) |> 
gt::gt(cap = "% coûts analysés") |> 
gt::fmt_percent(col = pc_cout_analyse, deci = 0)
```

## Visualisation des Coûts par composant

```{r}
#| label: pareto_cout_cat
#| include: true
plot_pareto_cout(NULL, categorie, "DPA : Pareto des couts par composant", is_global = TRUE)
```

## Visualisation des Coûts pour les Vérins Piqueurs

```{r}
#| label: pareto_cout_vp
#| include: true
plot_pareto_cout("verin_piqueur", poste, "Décomposition des Coûts pour les Vérins Piqueurs")
```

## Visualisation des Coûts pour Pointerolle/Rallonge

```{r}
#| label: pareto_cout_point
#| include: true
plot_pareto_cout("pointerolle_rallonge", poste, "Décomposition des Coûts Pointerolle/Rallonge")
```

## Visualisation des Coûts Distributeur

```{r}
#| label: pareto_cout_distr
#| include: true
plot_pareto_cout("distributeur", poste, "Décomposition des Coûts Distributeur")
```